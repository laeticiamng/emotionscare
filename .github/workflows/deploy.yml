name: Deploy

on:
  workflow_dispatch:
    inputs:
      base_url:
        description: 'URL de l\'environnement à valider avant déploiement (ex: https://preview.example.com)'
        required: true

jobs:
  pre-deploy-smoke:
    name: Vérifications pré-déploiement (sans JS)
    runs-on: ubuntu-latest
    steps:
      - name: Lancer les sondes HTTP
        env:
          BASE_URL: ${{ inputs.base_url }}
        run: |
          set -euo pipefail
          if [ -z "${BASE_URL:-}" ]; then
            echo "L'URL de base est obligatoire pour exécuter les tests pré-déploiement." >&2
            exit 1
          fi

          BASE_URL="${BASE_URL%/}"

          echo "Sonde de la page d'accueil (${BASE_URL}/)"
          curl -fsSL "${BASE_URL}/" | grep -F "Chargement d'EmotionsCare..."

          echo "Sonde de la page hors-ligne (${BASE_URL}/offline.html)"
          curl -fsSL "${BASE_URL}/offline.html" | grep -F "Mode hors ligne"

          echo "Sonde de la route de santé (${BASE_URL}/healthz.html)"
          curl -fsSL "${BASE_URL}/healthz.html" | grep -F "EMOTIONSCARE_HEALTHCHECK_OK"

          echo "Toutes les sondes HTTP sont passées avec succès."

  load-tests:
    name: Tests de charge K6
    runs-on: ubuntu-latest
    needs: pre-deploy-smoke
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install K6
        run: |
          sudo gpg -k
          sudo gpg --no-default-keyring --keyring /usr/share/keyrings/k6-archive-keyring.gpg --keyserver hkp://keyserver.ubuntu.com:80 --recv-keys C5AD17C747E3415A3642D57D77C6C491D6AC1D69
          echo "deb [signed-by=/usr/share/keyrings/k6-archive-keyring.gpg] https://dl.k6.io/deb stable main" | sudo tee /etc/apt/sources.list.d/k6.list
          sudo apt-get update
          sudo apt-get install k6

      - name: Execute K6 load tests
        env:
          BASE_URL: ${{ inputs.base_url }}
        run: |
          k6 run tests/load/k6-edge-functions-rgpd.js --env BASE_URL="${BASE_URL}" --summary-export=k6-summary.json

      - name: Upload K6 metrics to Supabase
        if: success()
        env:
          VITE_SUPABASE_URL: ${{ secrets.VITE_SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
        run: |
          npm install @supabase/supabase-js
          node tests/load/k6-results-uploader.js k6-summary.json

      - name: Upload K6 report artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: k6-report
          path: k6-summary.json

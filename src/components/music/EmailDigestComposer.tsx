/**
 * Email Digest Composer - Configuration et pr√©visualisation des digests hebdomadaires
 * Gestion des pr√©f√©rences d'email, planification, et test d'envoi
 */

import React, { useState, useEffect } from 'react';
import { motion, AnimatePresence } from 'framer-motion';
import { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';
import { Button } from '@/components/ui/button';
import { Badge } from '@/components/ui/badge';
import { Switch } from '@/components/ui/switch';
import {
  Mail,
  Send,
  Clock,
  CheckCircle,
  AlertCircle,
  Eye,
  Settings,
  MailPlus,
  Trash2,
  RefreshCw,
} from 'lucide-react';
import { useToast } from '@/hooks/use-toast';

interface EmailDigestComposerProps {
  userId?: string;
  onEmailPreferenceChange?: (enabled: boolean, frequency: string, timeOfDay: string) => void;
  onTestEmailSent?: () => void;\n}

export const EmailDigestComposer: React.FC<EmailDigestComposerProps> = ({\n  userId = 'user-123',\n  onEmailPreferenceChange,\n  onTestEmailSent,\n}) => {\n  const { toast } = useToast();\n  const [emailEnabled, setEmailEnabled] = useState(true);\n  const [frequency, setFrequency] = useState<'weekly' | 'biweekly' | 'monthly'>('weekly');\n  const [dayOfWeek, setDayOfWeek] = useState(0); // 0 = Sunday\n  const [timeOfDay, setTimeOfDay] = useState('09:00');\n  const [recipientEmail, setRecipientEmail] = useState('user@example.com');\n  const [includeStats, setIncludeStats] = useState(true);\n  const [includeRecommendations, setIncludeRecommendations] = useState(true);\n  const [includeAchievements, setIncludeAchievements] = useState(true);\n  const [includeCollaboration, setIncludeCollaboration] = useState(true);\n  const [showPreview, setShowPreview] = useState(false);\n  const [sending, setSending] = useState(false);\n  const [scheduledEmails, setScheduledEmails] = useState<any[]>([]);\n\n  // Simulated email stats\n  const emailStats = {\n    totalScheduled: 12,\n    totalSent: 10,\n    totalFailed: 1,\n    pendingCount: 1,\n  };\n\n  const daysOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];\n\n  // Save preferences\n  useEffect(() => {\n    onEmailPreferenceChange?.(emailEnabled, frequency, timeOfDay);\n  }, [emailEnabled, frequency, timeOfDay, onEmailPreferenceChange]);\n\n  // Mock scheduled emails\n  useEffect(() => {\n    setScheduledEmails([\n      {\n        id: '1',\n        recipient: 'user@example.com',\n        subject: 'üéµ Your Weekly Music Digest - Calm Week!',\n        scheduledTime: new Date(Date.now() + 86400000 * 2),\n        sent: false,\n      },\n      {\n        id: '2',\n        recipient: 'user@example.com',\n        subject: 'üéµ Your Weekly Music Digest - Energetic Week!',\n        scheduledTime: new Date(Date.now() + 86400000 * 9),\n        sent: false,\n      },\n    ]);\n  }, []);\n\n  const sendTestEmail = async () => {\n    setSending(true);\n\n    try {\n      toast({\n        title: 'üìß Sending test email...',\n        description: `Test digest to ${recipientEmail}`,\n      });\n\n      // Simulate email sending\n      await new Promise((resolve) => setTimeout(resolve, 2000));\n\n      toast({\n        title: '‚úÖ Test email sent!',\n        description: `Check ${recipientEmail} for the preview`,\n      });\n\n      onTestEmailSent?.();\n    } catch (error) {\n      toast({\n        title: '‚ùå Failed to send test email',\n        description: 'Please try again',\n        variant: 'destructive',\n      });\n    } finally {\n      setSending(false);\n    }\n  };\n\n  const formatScheduleTime = (date: Date): string => {\n    const now = new Date();\n    const diffMs = date.getTime() - now.getTime();\n    const diffDays = Math.floor(diffMs / 86400000);\n    const diffHours = Math.floor((diffMs % 86400000) / 3600000);\n\n    if (diffDays === 0 && diffHours < 24) return `In ${diffHours}h`;\n    if (diffDays === 1) return 'Tomorrow';\n    if (diffDays < 7) return `In ${diffDays} days`;\n    return date.toLocaleDateString('fr-FR');\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"space-y-2\">\n        <h2 className=\"text-2xl font-bold text-foreground flex items-center gap-2\">\n          <Mail className=\"h-6 w-6\" />\n          Email Digest Manager\n        </h2>\n        <p className=\"text-muted-foreground\">\n          Configure and manage your weekly music digest emails\n        </p>\n      </div>\n\n      {/* Quick Stats */}\n      <div className=\"grid grid-cols-2 md:grid-cols-4 gap-3\">\n        <Card>\n          <CardContent className=\"p-4 text-center space-y-2\">\n            <p className=\"text-sm text-muted-foreground\">Total Scheduled</p>\n            <p className=\"text-3xl font-bold\">{emailStats.totalScheduled}</p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-4 text-center space-y-2\">\n            <p className=\"text-sm text-muted-foreground\">Sent</p>\n            <p className=\"text-3xl font-bold text-green-500\">{emailStats.totalSent}</p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-4 text-center space-y-2\">\n            <p className=\"text-sm text-muted-foreground\">Pending</p>\n            <p className=\"text-3xl font-bold text-yellow-500\">{emailStats.pendingCount}</p>\n          </CardContent>\n        </Card>\n        <Card>\n          <CardContent className=\"p-4 text-center space-y-2\">\n            <p className=\"text-sm text-muted-foreground\">Failed</p>\n            <p className=\"text-3xl font-bold text-red-500\">{emailStats.totalFailed}</p>\n          </CardContent>\n        </Card>\n      </div>\n\n      {/* Email Preferences */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">‚öôÔ∏è Email Preferences</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-6\">\n          {/* Enable/Disable */}\n          <div className=\"flex items-center justify-between p-4 rounded-lg bg-muted/30 border\">\n            <div>\n              <p className=\"font-medium\">Enable Email Digests</p>\n              <p className=\"text-sm text-muted-foreground\">Receive weekly email summaries</p>\n            </div>\n            <Switch checked={emailEnabled} onCheckedChange={setEmailEnabled} />\n          </div>\n\n          {emailEnabled && (\n            <motion.div\n              initial={{ opacity: 0, height: 0 }}\n              animate={{ opacity: 1, height: 'auto' }}\n              exit={{ opacity: 0, height: 0 }}\n              className=\"space-y-6\"\n            >\n              {/* Recipient Email */}\n              <div className=\"space-y-3\">\n                <label className=\"text-sm font-medium\">üìß Recipient Email</label>\n                <div className=\"flex gap-2\">\n                  <input\n                    type=\"email\"\n                    value={recipientEmail}\n                    onChange={(e) => setRecipientEmail(e.target.value)}\n                    placeholder=\"your@email.com\"\n                    className=\"flex-1 px-3 py-2 border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent text-sm\"\n                  />\n                  <Button\n                    size=\"sm\"\n                    variant=\"outline\"\n                    onClick={() => {\n                      toast({\n                        title: '‚úÖ Email verified',\n                        description: 'A verification link has been sent',\n                      });\n                    }}\n                  >\n                    Verify\n                  </Button>\n                </div>\n              </div>\n\n              {/* Frequency */}\n              <div className=\"space-y-3\">\n                <label className=\"text-sm font-medium\">üìÖ Frequency</label>\n                <div className=\"grid grid-cols-3 gap-2\">\n                  {(['weekly', 'biweekly', 'monthly'] as const).map((freq) => (\n                    <Button\n                      key={freq}\n                      variant={frequency === freq ? 'default' : 'outline'}\n                      size=\"sm\"\n                      onClick={() => setFrequency(freq)}\n                      className=\"capitalize\"\n                    >\n                      {freq}\n                    </Button>\n                  ))}\n                </div>\n              </div>\n\n              {/* Day of Week */}\n              <div className=\"space-y-3\">\n                <label className=\"text-sm font-medium\">üìÜ Send on...</label>\n                <div className=\"grid grid-cols-4 gap-2\">\n                  {daysOfWeek.map((day, idx) => (\n                    <Button\n                      key={day}\n                      variant={dayOfWeek === idx ? 'default' : 'outline'}\n                      size=\"sm\"\n                      onClick={() => setDayOfWeek(idx)}\n                      className=\"text-xs\"\n                    >\n                      {day.slice(0, 3)}\n                    </Button>\n                  ))}\n                </div>\n              </div>\n\n              {/* Time of Day */}\n              <div className=\"space-y-3\">\n                <label className=\"text-sm font-medium\">üïê Time of Day</label>\n                <div className=\"flex gap-2 items-center\">\n                  <input\n                    type=\"time\"\n                    value={timeOfDay}\n                    onChange={(e) => setTimeOfDay(e.target.value)}\n                    className=\"px-3 py-2 border rounded-lg bg-background focus:outline-none focus:ring-2 focus:ring-accent\"\n                  />\n                  <Badge variant=\"secondary\" className=\"text-xs\">\n                    {daysOfWeek[dayOfWeek]} at {timeOfDay}\n                  </Badge>\n                </div>\n              </div>\n\n              {/* Content Options */}\n              <div className=\"space-y-3 p-4 rounded-lg bg-accent/5 border border-accent/20\">\n                <p className=\"text-sm font-medium\">Include in Digest:</p>\n                <div className=\"space-y-2\">\n                  <div className=\"flex items-center justify-between\">\n                    <label className=\"text-sm\">üìä Statistics</label>\n                    <Switch checked={includeStats} onCheckedChange={setIncludeStats} />\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <label className=\"text-sm\">üí° Recommendations</label>\n                    <Switch\n                      checked={includeRecommendations}\n                      onCheckedChange={setIncludeRecommendations}\n                    />\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <label className=\"text-sm\">üèÜ Achievements</label>\n                    <Switch checked={includeAchievements} onCheckedChange={setIncludeAchievements} />\n                  </div>\n                  <div className=\"flex items-center justify-between\">\n                    <label className=\"text-sm\">üë• Collaboration Updates</label>\n                    <Switch\n                      checked={includeCollaboration}\n                      onCheckedChange={setIncludeCollaboration}\n                    />\n                  </div>\n                </div>\n              </div>\n\n              {/* Actions */}\n              <div className=\"flex gap-2 pt-4\">\n                <Button\n                  onClick={sendTestEmail}\n                  disabled={sending}\n                  className=\"flex-1 gap-2\"\n                  variant=\"outline\"\n                >\n                  {sending ? (\n                    <>\n                      <motion.div animate={{ rotate: 360 }} transition={{ duration: 1, repeat: Infinity }}>\n                        <RefreshCw className=\"h-4 w-4\" />\n                      </motion.div>\n                      Sending...\n                    </>\n                  ) : (\n                    <>\n                      <Eye className=\"h-4 w-4\" />\n                      Send Test Email\n                    </>\n                  )}\n                </Button>\n                <Button onClick={() => setShowPreview(!showPreview)} variant=\"outline\" className=\"flex-1 gap-2\">\n                  Preview\n                </Button>\n              </div>\n            </motion.div>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Email Preview */}\n      <AnimatePresence>\n        {showPreview && emailEnabled && (\n          <motion.div\n            initial={{ opacity: 0, y: 10 }}\n            animate={{ opacity: 1, y: 0 }}\n            exit={{ opacity: 0, y: 10 }}\n          >\n            <Card className=\"border-blue-200 bg-blue-50/30\">\n              <CardHeader>\n                <CardTitle className=\"text-lg\">üìß Email Preview</CardTitle>\n              </CardHeader>\n              <CardContent>\n                <div className=\"p-4 rounded-lg bg-white border\">\n                  <div className=\"text-sm space-y-4\">\n                    <div>\n                      <p className=\"font-semibold text-xs text-muted-foreground\">Subject</p>\n                      <p className=\"font-medium\">üéµ Your Weekly Music Digest - Calm Week!</p>\n                    </div>\n                    <div className=\"text-xs text-muted-foreground space-y-2\">\n                      <p>üìä <strong>Weekly Statistics</strong></p>\n                      <ul className=\"ml-4 space-y-1\">\n                        {includeStats && (\n                          <>\n                            <li>‚Ä¢ Total Sessions: 12</li>\n                            <li>‚Ä¢ Total Time: 4h 30m</li>\n                            <li>‚Ä¢ Current Streak: 7 days üî•</li>\n                          </>\n                        )}\n                      </ul>\n                    </div>\n                    {includeRecommendations && (\n                      <div className=\"text-xs text-muted-foreground space-y-2\">\n                        <p>üí° <strong>Personalized Recommendations</strong></p>\n                        <ul className=\"ml-4 space-y-1\">\n                          <li>‚Ä¢ Focus Music - Perfect for productivity</li>\n                          <li>‚Ä¢ Relaxing Piano - Great for evening</li>\n                        </ul>\n                      </div>\n                    )}\n                    {includeAchievements && (\n                      <div className=\"text-xs text-muted-foreground space-y-2\">\n                        <p>üèÜ <strong>Achievements Unlocked</strong></p>\n                        <ul className=\"ml-4 space-y-1\">\n                          <li>‚Ä¢ Week Warrior - 7 days streak</li>\n                          <li>‚Ä¢ Playlist Master - Created 3 playlists</li>\n                        </ul>\n                      </div>\n                    )}\n                  </div>\n                </div>\n              </CardContent>\n            </Card>\n          </motion.div>\n        )}\n      </AnimatePresence>\n\n      {/* Scheduled Emails */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"flex items-center gap-2\">\n            <Clock className=\"h-5 w-5\" />\n            Scheduled Emails\n          </CardTitle>\n        </CardHeader>\n        <CardContent>\n          {scheduledEmails.length > 0 ? (\n            <div className=\"space-y-3\">\n              <AnimatePresence>\n                {scheduledEmails.map((email) => (\n                  <motion.div\n                    key={email.id}\n                    initial={{ opacity: 0, x: -10 }}\n                    animate={{ opacity: 1, x: 0 }}\n                    exit={{ opacity: 0, x: -10 }}\n                    className={`p-4 rounded-lg border transition-all ${\n                      email.sent ? 'bg-green-500/10 border-green-500/20' : 'bg-muted/30 border-muted'\n                    }`}\n                  >\n                    <div className=\"flex items-start justify-between gap-3\">\n                      <div className=\"flex-1 min-w-0 space-y-2\">\n                        <div className=\"flex items-center gap-2\">\n                          {email.sent ? (\n                            <CheckCircle className=\"h-4 w-4 text-green-500 flex-shrink-0\" />\n                          ) : (\n                            <AlertCircle className=\"h-4 w-4 text-yellow-500 flex-shrink-0\" />\n                          )}\n                          <p className=\"font-medium text-sm truncate\">{email.subject}</p>\n                        </div>\n                        <p className=\"text-xs text-muted-foreground\">\n                          To: {email.recipient}\n                        </p>\n                        <p className=\"text-xs text-muted-foreground\">\n                          ‚è∞ {email.sent ? 'Sent' : formatScheduleTime(email.scheduledTime)}\n                        </p>\n                      </div>\n                      <Button\n                        size=\"sm\"\n                        variant=\"ghost\"\n                        className=\"h-8 w-8 p-0 flex-shrink-0\"\n                        onClick={() => {\n                          setScheduledEmails((prev) => prev.filter((e) => e.id !== email.id));\n                        }}\n                      >\n                        <Trash2 className=\"h-4 w-4\" />\n                      </Button>\n                    </div>\n                  </motion.div>\n                ))}\n              </AnimatePresence>\n            </div>\n          ) : (\n            <p className=\"text-sm text-muted-foreground text-center py-6\">\n              No scheduled emails\n            </p>\n          )}\n        </CardContent>\n      </Card>\n\n      {/* Features Info */}\n      <Card>\n        <CardHeader>\n          <CardTitle className=\"text-lg\">‚ú® Features</CardTitle>\n        </CardHeader>\n        <CardContent className=\"space-y-3 text-sm text-muted-foreground\">\n          <div className=\"space-y-2\">\n            <p className=\"font-semibold text-foreground\">üìß Email Digest Features:</p>\n            <ul className=\"ml-4 space-y-1\">\n              <li>‚úÖ Weekly, biweekly, or monthly delivery</li>\n              <li>‚úÖ Customizable send day and time</li>\n              <li>‚úÖ Personalized statistics and insights</li>\n              <li>‚úÖ AI recommendations based on listening habits</li>\n              <li>‚úÖ Achievement and streak notifications</li>\n              <li>‚úÖ Test email preview before scheduling</li>\n              <li>‚úÖ Detailed tracking of sent emails</li>\n            </ul>\n          </div>\n        </CardContent>\n      </Card>\n    </div>\n  );\n};\n\nexport default EmailDigestComposer;

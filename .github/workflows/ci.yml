name: CI

on:
  push:
    branches: [feat/dashboard-widgets]
  pull_request:

env:
  SKIP_HEAVY: "true"
  NODE_VERSION: "20"

jobs:
  build-test:
    runs-on: ubuntu-22.04
    timeout-minutes: 25
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: ${{ env.NODE_VERSION }}

      # 1. install offline-friendly
      - run: |
          npm ci --prefer-offline --no-audit --no-fund --legacy-peer-deps

      # 2. lint + types
      - run: npm run lint
      - run: npm run tsc -- --noEmit

      # 3. unit + db tests
      - run: npm run test:db --if-present
      - run: npm run test -- --coverage --environment=jsdom

      # 4. upload coverage
      - uses: actions/upload-artifact@v4
        with:
          name: coverage
          path: coverage

      # 5. security audit
      - run: npm audit --omit dev || true
      - run: npx owasp-depcheck --failOnCritical

  e2e-web:
    runs-on: ubuntu-22.04
    needs: build-test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: 20
      - run: npm ci
      - run: npm run start &
      - run: npm run test:e2e:web

  e2e-mobile:
    runs-on: macos-13
    needs: build-test
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v3
        with:
          node-version: 20
      - run: npm ci
      - run: npm run test:e2e:mobile

/**\n * Push Notification Manager - Gestion des notifications web push\n * Configuration, permissions, et statistiques en temps r√©el\n */\n\nimport React, { useState, useEffect } from 'react';\nimport { motion, AnimatePresence } from 'framer-motion';\nimport { Card, CardContent, CardHeader, CardTitle } from '@/components/ui/card';\nimport { Button } from '@/components/ui/button';\nimport { Badge } from '@/components/ui/badge';\nimport { Switch } from '@/components/ui/switch';\nimport {\n  Bell,\n  CheckCircle,\n  AlertCircle,\n  Send,\n  Clock,\n  Smartphone,\n  Settings,\n  Eye,\n  Trash2,\n  RefreshCw,\n} from 'lucide-react';\nimport { useToast } from '@/hooks/use-toast';\n\ninterface PushNotificationManagerProps {\n  userId?: string;\n  onPermissionRequested?: (permission: NotificationPermission) => void;\n  onNotificationSent?: (title: string, body: string) => void;\n}\n\nexport const PushNotificationManager: React.FC<PushNotificationManagerProps> = ({\n  userId = 'user-123',\n  onPermissionRequested,\n  onNotificationSent,\n}) => {\n  const { toast } = useToast();\n  const [notificationsEnabled, setNotificationsEnabled] = useState(true);\n  const [permissionStatus, setPermissionStatus] = useState<NotificationPermission>('default');\n  const [isSupported, setIsSupported] = useState(true);\n  const [quietHoursEnabled, setQuietHoursEnabled] = useState(false);\n  const [quietStart, setQuietStart] = useState('22:00');\n  const [quietEnd, setQuietEnd] = useState('07:00');\n  const [categories, setCategories] = useState({\n    musicUpdates: true,\n    achievements: true,\n    recommendations: true,\n    social: false,\n    reminders: true,\n  });\n  const [notificationLog, setNotificationLog] = useState<any[]>([]);\n  const [stats, setStats] = useState({\n    totalSent: 24,\n    totalClicked: 18,\n    clickRate: 75,\n  });\n  const [sending, setSending] = useState(false);\n\n  // Check support and permission on mount\n  useEffect(() => {\n    const checkSupport = () => {\n      const supported = 'serviceWorker' in navigator && 'PushManager' in window && 'Notification' in window;\n      setIsSupported(supported);\n\n      if (supported && 'Notification' in window) {\n        setPermissionStatus(Notification.permission);\n      }\n    };\n\n    checkSupport();\n  }, []);\n\n  // Simulate notification log\n  useEffect(() => {\n    setNotificationLog([\n      {\n        id: '1',\n        title: 'üéµ New Playlist Recommended',\n        body: 'Focus Beats - Perfect for concentration',\n        sentTime: new Date(Date.now() - 3600000),\n        clicked: true,\n      },\n      {\n        id: '2',\n        title: 'üèÜ Achievement Unlocked',\n        body: 'Week Warrior - 7 days listening streak',\n        sentTime: new Date(Date.now() - 7200000),\n        clicked: true,\n      },\n      {\n        id: '3',\n        title: '‚è∞ Daily Reminder',\n        body: 'Time to relax with some music',\n        sentTime: new Date(Date.now() - 10800000),\n        clicked: false,\n      },\n    ]);\n  }, []);\n\n  const requestPermission = async () => {\n    if (!isSupported) {\n      toast({\n        title: '‚ùå Not Supported',\n        description: 'Your browser does not support push notifications',\n        variant: 'destructive',\n      });\n      return;\n    }\n\n    try {\n      const permission = await Notification.requestPermission();\n      setPermissionStatus(permission);\n      onPermissionRequested?.(permission);\n\n      if (permission === 'granted') {\n        toast({\n          title: '‚úÖ Permission Granted',\n          description: 'You will now receive push notifications',\n        });\n      } else if (permission === 'denied') {\n        toast({\n          title: '‚ùå Permission Denied',\n          description: 'You can enable it in browser settings',\n          variant: 'destructive',\n        });\n      }\n    } catch (error) {\n      toast({\n        title: '‚ùå Error',\n        description: 'Failed to request permission',\n        variant: 'destructive',\n      });\n    }\n  };\n\n  const sendTestNotification = async () => {\n    setSending(true);\n\n    try {\n      const title = 'üéµ Test Notification';\n      const body = 'This is a test push notification from Emotions Care';\n\n      // Simulate sending\n      await new Promise((resolve) => setTimeout(resolve, 1500));\n\n      toast({\n        title: '‚úÖ Test notification sent!',\n        description: 'Check if you received it',\n      });\n\n      // Add to log\n      setNotificationLog((prev) => [\n        {\n          id: `test_${Date.now()}`,\n          title,\n          body,\n          sentTime: new Date(),\n          clicked: false,\n        },\n        ...prev,\n      ]);\n\n      onNotificationSent?.(title, body);\n    } catch (error) {\n      toast({\n        title: '‚ùå Failed to send test',\n        description: 'Please try again',\n        variant: 'destructive',\n      });\n    } finally {\n      setSending(false);\n    }\n  };\n\n  const toggleCategory = (category: keyof typeof categories) => {\n    setCategories((prev) => ({\n      ...prev,\n      [category]: !prev[category],\n    }));\n  };\n\n  const formatTime = (date: Date): string => {\n    const now = new Date();\n    const diffMs = now.getTime() - date.getTime();\n    const diffMins = Math.floor(diffMs / 60000);\n    const diffHours = Math.floor(diffMs / 3600000);\n\n    if (diffMins < 1) return 'Just now';\n    if (diffMins < 60) return `${diffMins}m ago`;\n    if (diffHours < 24) return `${diffHours}h ago`;\n    return date.toLocaleDateString();\n  };\n\n  return (\n    <div className=\"space-y-6\">\n      {/* Header */}\n      <div className=\"space-y-2\">\n        <h2 className=\"text-2xl font-bold text-foreground flex items-center gap-2\">\n          <Bell className=\"h-6 w-6\" />\n          Push Notification Manager\n        </h2>\n        <p className=\"text-muted-foreground\">\n          Configure browser push notifications for real-time updates\n        </p>\n      </div>\n\n      {/* Support Warning */}\n      {!isSupported && (\n        <motion.div\n          initial={{ opacity: 0, y: -10 }}\n          animate={{ opacity: 1, y: 0 }}\n          className=\"p-4 rounded-lg bg-red-500/10 border border-red-500/20\"\n        >\n          <div className=\"flex items-start gap-3\">\n            <AlertCircle className=\"h-5 w-5 text-red-500 flex-shrink-0 mt-0.5\" />\n            <div>\n              <p className=\"font-medium text-red-700\">Not Supported</p>\n              <p className=\"text-sm text-red-600/80\">\n                Your browser does not support push notifications. Please use a modern browser like Chrome, Firefox, or Edge.\n              </p>\n            </div>\n          </div>\n        </motion.div>\n      )}\n\n      {/* Quick Stats */}\n      {isSupported && (\n        <div className=\"grid grid-cols-3 gap-3\">\n          <Card>\n            <CardContent className=\"p-4 text-center space-y-2\">\n              <p className=\"text-sm text-muted-foreground\">Sent</p>\n              <p className=\"text-3xl font-bold\">{stats.totalSent}</p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"p-4 text-center space-y-2\">\n              <p className=\"text-sm text-muted-foreground\">Clicked</p>\n              <p className=\"text-3xl font-bold text-green-500\">{stats.totalClicked}</p>\n            </CardContent>\n          </Card>\n          <Card>\n            <CardContent className=\"p-4 text-center space-y-2\">\n              <p className=\"text-sm text-muted-foreground\">Click Rate</p>\n              <p className=\"text-3xl font-bold text-blue-500\">{stats.clickRate}%</p>\n            </CardContent>\n          </Card>\n        </div>\n      )}\n\n      {/* Permission Status */}\n      {isSupported && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">üîî Permission Status</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-4\">\n            <div className=\"flex items-center justify-between p-4 rounded-lg bg-muted/30 border\">\n              <div className=\"flex items-center gap-3\">\n                {permissionStatus === 'granted' ? (\n                  <CheckCircle className=\"h-5 w-5 text-green-500\" />\n                ) : permissionStatus === 'denied' ? (\n                  <AlertCircle className=\"h-5 w-5 text-red-500\" />\n                ) : (\n                  <AlertCircle className=\"h-5 w-5 text-yellow-500\" />\n                )}\n                <div>\n                  <p className=\"font-medium\">Permission: {permissionStatus}</p>\n                  <p className=\"text-xs text-muted-foreground\">\n                    {permissionStatus === 'granted'\n                      ? 'You will receive push notifications'\n                      : permissionStatus === 'denied'\n                        ? 'Enable in browser settings to receive notifications'\n                        : 'Click below to enable notifications'}\n                  </p>\n                </div>\n              </div>\n              {permissionStatus !== 'granted' && (\n                <Button onClick={requestPermission} size=\"sm\" className=\"gap-2\">\n                  <Smartphone className=\"h-4 w-4\" />\n                  Enable\n                </Button>\n              )}\n            </div>\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Preferences */}\n      {isSupported && permissionStatus === 'granted' && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">‚öôÔ∏è Preferences</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-6\">\n            {/* Master Toggle */}\n            <div className=\"flex items-center justify-between p-4 rounded-lg bg-muted/30 border\">\n              <div>\n                <p className=\"font-medium\">Enable Push Notifications</p>\n                <p className=\"text-xs text-muted-foreground\">Receive real-time updates on your device</p>\n              </div>\n              <Switch checked={notificationsEnabled} onCheckedChange={setNotificationsEnabled} />\n            </div>\n\n            {notificationsEnabled && (\n              <motion.div\n                initial={{ opacity: 0, height: 0 }}\n                animate={{ opacity: 1, height: 'auto' }}\n                exit={{ opacity: 0, height: 0 }}\n                className=\"space-y-6\"\n              >\n                {/* Categories */}\n                <div className=\"space-y-3\">\n                  <p className=\"text-sm font-medium\">üìÇ Notification Categories</p>\n                  <div className=\"space-y-2\">\n                    {[\n                      { key: 'musicUpdates', label: 'üéµ Music Updates', description: 'New releases and playlists' },\n                      { key: 'achievements', label: 'üèÜ Achievements', description: 'Badges and milestones' },\n                      { key: 'recommendations', label: 'üí° Recommendations', description: 'Personalized suggestions' },\n                      { key: 'social', label: 'üë• Social', description: 'Friend activities' },\n                      { key: 'reminders', label: '‚è∞ Reminders', description: 'Daily listening reminders' },\n                    ].map(({ key, label, description }) => (\n                      <div key={key} className=\"flex items-center justify-between p-3 rounded-lg bg-accent/5 border border-accent/20\">\n                        <div>\n                          <p className=\"text-sm font-medium\">{label}</p>\n                          <p className=\"text-xs text-muted-foreground\">{description}</p>\n                        </div>\n                        <Switch\n                          checked={categories[key as keyof typeof categories]}\n                          onCheckedChange={() => toggleCategory(key as keyof typeof categories)}\n                        />\n                      </div>\n                    ))}\n                  </div>\n                </div>\n\n                {/* Quiet Hours */}\n                <div className=\"space-y-3 p-4 rounded-lg bg-accent/5 border border-accent/20\">\n                  <div className=\"flex items-center justify-between\">\n                    <p className=\"text-sm font-medium\">üåô Quiet Hours</p>\n                    <Switch checked={quietHoursEnabled} onCheckedChange={setQuietHoursEnabled} />\n                  </div>\n\n                  {quietHoursEnabled && (\n                    <motion.div\n                      initial={{ opacity: 0, height: 0 }}\n                      animate={{ opacity: 1, height: 'auto' }}\n                      className=\"flex gap-2 items-center\"\n                    >\n                      <input\n                        type=\"time\"\n                        value={quietStart}\n                        onChange={(e) => setQuietStart(e.target.value)}\n                        className=\"px-3 py-2 border rounded-lg bg-background text-sm\"\n                      />\n                      <span className=\"text-xs text-muted-foreground\">to</span>\n                      <input\n                        type=\"time\"\n                        value={quietEnd}\n                        onChange={(e) => setQuietEnd(e.target.value)}\n                        className=\"px-3 py-2 border rounded-lg bg-background text-sm\"\n                      />\n                    </motion.div>\n                  )}\n                </div>\n\n                {/* Test Button */}\n                <Button\n                  onClick={sendTestNotification}\n                  disabled={sending}\n                  className=\"w-full gap-2\"\n                  variant=\"outline\"\n                >\n                  {sending ? (\n                    <>\n                      <motion.div animate={{ rotate: 360 }} transition={{ duration: 1, repeat: Infinity }}>\n                        <RefreshCw className=\"h-4 w-4\" />\n                      </motion.div>\n                      Sending...\n                    </>\n                  ) : (\n                    <>\n                      <Send className=\"h-4 w-4\" />\n                      Send Test Notification\n                    </>\n                  )}\n                </Button>\n              </motion.div>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Notification Log */}\n      {isSupported && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"flex items-center gap-2\">\n              <Clock className=\"h-5 w-5\" />\n              Recent Notifications\n            </CardTitle>\n          </CardHeader>\n          <CardContent>\n            {notificationLog.length > 0 ? (\n              <div className=\"space-y-3 max-h-96 overflow-y-auto\">\n                <AnimatePresence>\n                  {notificationLog.map((notif) => (\n                    <motion.div\n                      key={notif.id}\n                      initial={{ opacity: 0, x: -10 }}\n                      animate={{ opacity: 1, x: 0 }}\n                      exit={{ opacity: 0, x: -10 }}\n                      className={`p-4 rounded-lg border transition-all ${\n                        notif.clicked\n                          ? 'bg-green-500/10 border-green-500/20'\n                          : 'bg-muted/30 border-muted'\n                      }`}\n                    >\n                      <div className=\"flex items-start justify-between gap-3\">\n                        <div className=\"flex-1 min-w-0 space-y-1\">\n                          <div className=\"flex items-center gap-2\">\n                            {notif.clicked && (\n                              <CheckCircle className=\"h-4 w-4 text-green-500 flex-shrink-0\" />\n                            )}\n                            <p className=\"font-medium text-sm truncate\">{notif.title}</p>\n                          </div>\n                          <p className=\"text-sm text-muted-foreground truncate\">{notif.body}</p>\n                          <p className=\"text-xs text-muted-foreground\">\n                            ‚è∞ {formatTime(notif.sentTime)}\n                          </p>\n                        </div>\n                        <Button\n                          size=\"sm\"\n                          variant=\"ghost\"\n                          className=\"h-8 w-8 p-0 flex-shrink-0\"\n                          onClick={() => {\n                            setNotificationLog((prev) => prev.filter((n) => n.id !== notif.id));\n                          }}\n                        >\n                          <Trash2 className=\"h-4 w-4\" />\n                        </Button>\n                      </div>\n                    </motion.div>\n                  ))}\n                </AnimatePresence>\n              </div>\n            ) : (\n              <p className=\"text-sm text-muted-foreground text-center py-6\">No notifications yet</p>\n            )}\n          </CardContent>\n        </Card>\n      )}\n\n      {/* Features Info */}\n      {isSupported && (\n        <Card>\n          <CardHeader>\n            <CardTitle className=\"text-lg\">‚ú® Features</CardTitle>\n          </CardHeader>\n          <CardContent className=\"space-y-3 text-sm text-muted-foreground\">\n            <div className=\"space-y-2\">\n              <p className=\"font-semibold text-foreground\">üîî Push Notification Features:</p>\n              <ul className=\"ml-4 space-y-1\">\n                <li>‚úÖ Browser push notifications with rich content</li>\n                <li>‚úÖ Service Worker integration for background notifications</li>\n                <li>‚úÖ Category-based notification filtering</li>\n                <li>‚úÖ Quiet hours to avoid interruptions</li>\n                <li>‚úÖ Real-time notification tracking</li>\n                <li>‚úÖ Click analytics and engagement metrics</li>\n                <li>‚úÖ Test notification feature</li>\n              </ul>\n            </div>\n          </CardContent>\n        </Card>\n      )}\n    </div>\n  );\n};\n\nexport default PushNotificationManager;

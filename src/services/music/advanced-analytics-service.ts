/**\n * Advanced Analytics Service - Analyses d√©taill√©es et insights\n * M√©triques, tendances, pr√©dictions, et rapports personnalis√©s\n */\n\nimport { logger } from '@/lib/logger';\n\ninterface ListeningSession {\n  id: string;\n  userId: string;\n  startTime: Date;\n  endTime: Date;\n  totalDuration: number; // in minutes\n  tracks: Array<{\n    id: string;\n    title: string;\n    artist: string;\n    duration: number;\n    mood: string;\n    playCount: number;\n  }>;\n  moodAtStart: string;\n  moodAtEnd: string;\n  deviceType: 'desktop' | 'mobile' | 'tablet';\n  location?: string;\n}\n\ninterface MusicAnalytics {\n  userId: string;\n  totalSessionCount: number;\n  totalListeningTime: number; // in minutes\n  averageSessionDuration: number;\n  favoriteGenre: string;\n  favoriteMood: string;\n  topArtists: Array<{ name: string; playCount: number; percentage: number }>;\n  topTracks: Array<{ title: string; artist: string; playCount: number }>;\n  moodDistribution: Record<string, number>;\n  listeningTimeByHour: Record<number, number>;\n  listeningTimeByDayOfWeek: Record<number, number>;\n  genreDistribution: Record<string, number>;\n  deviceDistribution: Record<string, number>;\n  weeklyTrend: Array<{ week: number; hours: number }>;\n  streakDays: number;\n  engagementScore: number; // 0-100\n}\n\ninterface UserInsight {\n  type: 'trend' | 'pattern' | 'recommendation' | 'milestone' | 'warning';\n  title: string;\n  description: string;\n  value?: string | number;\n  severity: 'info' | 'success' | 'warning' | 'critical';\n  timestamp: Date;\n}\n\ninterface AnalyticsReport {\n  id: string;\n  userId: string;\n  generatedAt: Date;\n  period: 'daily' | 'weekly' | 'monthly';\n  analytics: MusicAnalytics;\n  insights: UserInsight[];\n  recommendations: string[];\n  exportFormat?: 'pdf' | 'json' | 'csv';\n}\n\nclass AdvancedAnalyticsService {\n  private static instance: AdvancedAnalyticsService;\n  private sessions: Map<string, ListeningSession[]> = new Map();\n  private analytics: Map<string, MusicAnalytics> = new Map();\n  private insights: Map<string, UserInsight[]> = new Map();\n  private reports: AnalyticsReport[] = [];\n\n  private constructor() {\n    this.loadFromLocalStorage();\n    logger.info('Advanced Analytics Service initialized', {}, 'ANALYTICS_SERVICE');\n  }\n\n  static getInstance(): AdvancedAnalyticsService {\n    if (!AdvancedAnalyticsService.instance) {\n      AdvancedAnalyticsService.instance = new AdvancedAnalyticsService();\n    }\n    return AdvancedAnalyticsService.instance;\n  }\n\n  /**\n   * Record a listening session\n   */\n  recordSession(userId: string, session: ListeningSession): void {\n    if (!this.sessions.has(userId)) {\n      this.sessions.set(userId, []);\n    }\n\n    this.sessions.get(userId)!.push(session);\n    this.updateAnalytics(userId);\n    this.saveToLocalStorage();\n\n    logger.info(`Session recorded for ${userId}`, { userId, duration: session.totalDuration }, 'ANALYTICS_SERVICE');\n  }\n\n  /**\n   * Get user analytics\n   */\n  getAnalytics(userId: string): MusicAnalytics {\n    return (\n      this.analytics.get(userId) || {\n        userId,\n        totalSessionCount: 0,\n        totalListeningTime: 0,\n        averageSessionDuration: 0,\n        favoriteGenre: 'Unknown',\n        favoriteMood: 'Neutral',\n        topArtists: [],\n        topTracks: [],\n        moodDistribution: {},\n        listeningTimeByHour: {},\n        listeningTimeByDayOfWeek: {},\n        genreDistribution: {},\n        deviceDistribution: {},\n        weeklyTrend: [],\n        streakDays: 0,\n        engagementScore: 0,\n      }\n    );\n  }\n\n  /**\n   * Update analytics based on sessions\n   */\n  private updateAnalytics(userId: string): void {\n    const userSessions = this.sessions.get(userId) || [];\n\n    if (userSessions.length === 0) {\n      return;\n    }\n\n    // Calculate basic metrics\n    const totalListeningTime = userSessions.reduce((acc, s) => acc + s.totalDuration, 0);\n    const averageSessionDuration = totalListeningTime / userSessions.length;\n\n    // Calculate top artists\n    const artistMap = new Map<string, number>();\n    userSessions.forEach((session) => {\n      session.tracks.forEach((track) => {\n        artistMap.set(track.artist, (artistMap.get(track.artist) || 0) + track.playCount);\n      });\n    });\n\n    const topArtists = Array.from(artistMap.entries())\n      .sort((a, b) => b[1] - a[1])\n      .slice(0, 5)\n      .map(([name, count]) => ({\n        name,\n        playCount: count,\n        percentage: Math.round((count / totalListeningTime) * 100),\n      }));\n\n    // Calculate mood distribution\n    const moodMap = new Map<string, number>();\n    userSessions.forEach((session) => {\n      moodMap.set(session.moodAtStart, (moodMap.get(session.moodAtStart) || 0) + 1);\n    });\n\n    const moodDistribution: Record<string, number> = {};\n    moodMap.forEach((count, mood) => {\n      moodDistribution[mood] = count;\n    });\n\n    // Calculate streak\n    const streakDays = this.calculateStreak(userSessions);\n\n    // Calculate engagement score\n    const engagementScore = Math.min(\n      100,\n      (totalListeningTime / 60) * 2 + userSessions.length * 5 + streakDays * 2\n    );\n\n    const analytics: MusicAnalytics = {\n      userId,\n      totalSessionCount: userSessions.length,\n      totalListeningTime,\n      averageSessionDuration,\n      favoriteGenre: 'Mixed',\n      favoriteMood: Object.keys(moodDistribution).sort(\n        (a, b) => (moodDistribution[b] || 0) - (moodDistribution[a] || 0)\n      )[0] || 'Neutral',\n      topArtists,\n      topTracks: userSessions\n        .flatMap((s) => s.tracks)\n        .sort((a, b) => b.playCount - a.playCount)\n        .slice(0, 10),\n      moodDistribution,\n      listeningTimeByHour: this.calculateByHour(userSessions),\n      listeningTimeByDayOfWeek: this.calculateByDayOfWeek(userSessions),\n      genreDistribution: {},\n      deviceDistribution: this.calculateDeviceDistribution(userSessions),\n      weeklyTrend: this.calculateWeeklyTrend(userSessions),\n      streakDays,\n      engagementScore,\n    };\n\n    this.analytics.set(userId, analytics);\n  }\n\n  /**\n   * Calculate listening streak\n   */\n  private calculateStreak(sessions: ListeningSession[]): number {\n    if (sessions.length === 0) return 0;\n\n    // Sort sessions by date\n    const sorted = [...sessions].sort((a, b) => b.startTime.getTime() - a.startTime.getTime());\n\n    let streak = 0;\n    const today = new Date();\n    let currentDate = new Date(today.getFullYear(), today.getMonth(), today.getDate());\n\n    for (const session of sorted) {\n      const sessionDate = new Date(session.startTime.getFullYear(), session.startTime.getMonth(), session.startTime.getDate());\n      const daysDiff = Math.floor((currentDate.getTime() - sessionDate.getTime()) / (1000 * 60 * 60 * 24));\n\n      if (daysDiff <= streak + 1) {\n        streak++;\n      } else {\n        break;\n      }\n    }\n\n    return streak;\n  }\n\n  /**\n   * Calculate listening time by hour\n   */\n  private calculateByHour(sessions: ListeningSession[]): Record<number, number> {\n    const result: Record<number, number> = {};\n\n    for (let i = 0; i < 24; i++) {\n      result[i] = 0;\n    }\n\n    sessions.forEach((session) => {\n      const hour = session.startTime.getHours();\n      result[hour] = (result[hour] || 0) + session.totalDuration;\n    });\n\n    return result;\n  }\n\n  /**\n   * Calculate listening time by day of week\n   */\n  private calculateByDayOfWeek(sessions: ListeningSession[]): Record<number, number> {\n    const result: Record<number, number> = {};\n\n    for (let i = 0; i < 7; i++) {\n      result[i] = 0;\n    }\n\n    sessions.forEach((session) => {\n      const dayOfWeek = session.startTime.getDay();\n      result[dayOfWeek] = (result[dayOfWeek] || 0) + session.totalDuration;\n    });\n\n    return result;\n  }\n\n  /**\n   * Calculate device distribution\n   */\n  private calculateDeviceDistribution(sessions: ListeningSession[]): Record<string, number> {\n    const result: Record<string, number> = {};\n\n    sessions.forEach((session) => {\n      result[session.deviceType] = (result[session.deviceType] || 0) + 1;\n    });\n\n    return result;\n  }\n\n  /**\n   * Calculate weekly trend\n   */\n  private calculateWeeklyTrend(sessions: ListeningSession[]): Array<{ week: number; hours: number }> {\n    const weekMap = new Map<number, number>();\n\n    sessions.forEach((session) => {\n      const date = session.startTime;\n      const weekNumber = Math.floor((date.getTime() - new Date(date.getFullYear(), 0, 1).getTime()) / (7 * 24 * 60 * 60 * 1000));\n      weekMap.set(weekNumber, (weekMap.get(weekNumber) || 0) + session.totalDuration / 60); // Convert to hours\n    });\n\n    return Array.from(weekMap.entries())\n      .map(([week, hours]) => ({ week, hours: Math.round(hours * 10) / 10 }))\n      .sort((a, b) => a.week - b.week)\n      .slice(-12); // Last 12 weeks\n  }\n\n  /**\n   * Generate insights\n   */\n  generateInsights(userId: string): UserInsight[] {\n    const analytics = this.getAnalytics(userId);\n    const insights: UserInsight[] = [];\n\n    // Streak insight\n    if (analytics.streakDays >= 7) {\n      insights.push({\n        type: 'milestone',\n        title: `üî• ${analytics.streakDays}-Day Streak!`,\n        description: `You've been listening for ${analytics.streakDays} consecutive days. Keep it up!`,\n        value: analytics.streakDays,\n        severity: 'success',\n        timestamp: new Date(),\n      });\n    }\n\n    // Engagement insight\n    if (analytics.engagementScore > 75) {\n      insights.push({\n        type: 'trend',\n        title: 'üìà High Engagement',\n        description: 'Your engagement is excellent! You\\'re a music lover.',\n        value: `${Math.round(analytics.engagementScore)}%`,\n        severity: 'success',\n        timestamp: new Date(),\n      });\n    }\n\n    // Peak listening time\n    const hourEntries = Object.entries(analytics.listeningTimeByHour);\n    if (hourEntries.length > 0) {\n      const peakHour = parseInt(hourEntries.sort((a, b) => b[1] - a[1])[0][0]);\n      insights.push({\n        type: 'pattern',\n        title: '‚è∞ Peak Listening Time',\n        description: `You listen most often at ${peakHour}:00. Great for setting reminders!`,\n        value: `${peakHour}:00`,\n        severity: 'info',\n        timestamp: new Date(),\n      });\n    }\n\n    // Favorite mood\n    insights.push({\n      type: 'pattern',\n      title: 'üòä Favorite Mood',\n      description: `${analytics.favoriteMood} is your favorite mood for listening.`,\n      value: analytics.favoriteMood,\n      severity: 'info',\n      timestamp: new Date(),\n    });\n\n    this.insights.set(userId, insights);\n    return insights;\n  }\n\n  /**\n   * Get insights\n   */\n  getInsights(userId: string): UserInsight[] {\n    return this.insights.get(userId) || this.generateInsights(userId);\n  }\n\n  /**\n   * Generate report\n   */\n  generateReport(userId: string, period: 'daily' | 'weekly' | 'monthly' = 'weekly'): AnalyticsReport {\n    const analytics = this.getAnalytics(userId);\n    const insights = this.generateInsights(userId);\n\n    const recommendations: string[] = [];\n\n    if (analytics.engagementScore < 50) {\n      recommendations.push('Try to listen regularly to build a consistent habit.');\n    }\n    if (analytics.streakDays === 0) {\n      recommendations.push('Start your first listening streak today!');\n    }\n    if (analytics.topArtists.length === 0) {\n      recommendations.push('Explore new artists to diversify your music taste.');\n    }\n\n    const report: AnalyticsReport = {\n      id: `report_${userId}_${Date.now()}`,\n      userId,\n      generatedAt: new Date(),\n      period,\n      analytics,\n      insights,\n      recommendations,\n    };\n\n    this.reports.push(report);\n    this.saveToLocalStorage();\n\n    return report;\n  }\n\n  /**\n   * Get all reports\n   */\n  getReports(userId?: string): AnalyticsReport[] {\n    return userId ? this.reports.filter((r) => r.userId === userId) : this.reports;\n  }\n\n  /**\n   * Export report\n   */\n  exportReport(reportId: string, format: 'json' | 'csv' = 'json'): string {\n    const report = this.reports.find((r) => r.id === reportId);\n    if (!report) return '';\n\n    if (format === 'json') {\n      return JSON.stringify(report, null, 2);\n    } else if (format === 'csv') {\n      // Simple CSV export\n      const lines = [\n        'Metric,Value',\n        `Total Sessions,${report.analytics.totalSessionCount}`,\n        `Total Listening Time,${report.analytics.totalListeningTime} minutes`,\n        `Average Session,${Math.round(report.analytics.averageSessionDuration)} minutes`,\n        `Engagement Score,${report.analytics.engagementScore}/100`,\n        `Streak Days,${report.analytics.streakDays}`,\n      ];\n      return lines.join('\\n');\n    }\n\n    return '';\n  }\n\n  /**\n   * Get user stats summary\n   */\n  getStatsSummary(userId: string): any {\n    const analytics = this.getAnalytics(userId);\n    const insights = this.getInsights(userId);\n\n    return {\n      userId,\n      totalHours: Math.round(analytics.totalListeningTime / 60),\n      sessionCount: analytics.totalSessionCount,\n      favoriteArtist: analytics.topArtists[0]?.name || 'Unknown',\n      favoriteMood: analytics.favoriteMood,\n      streakDays: analytics.streakDays,\n      engagementScore: Math.round(analytics.engagementScore),\n      recentInsights: insights.slice(0, 3),\n    };\n  }\n\n  /**\n   * Clear all data\n   */\n  clearAll(): void {\n    this.sessions.clear();\n    this.analytics.clear();\n    this.insights.clear();\n    this.reports = [];\n    localStorage.removeItem('music:analytics');\n    logger.info('Cleared all analytics data', {}, 'ANALYTICS_SERVICE');\n  }\n\n  /**\n   * Save to localStorage\n   */\n  private saveToLocalStorage(): void {\n    try {\n      const data = {\n        sessions: Array.from(this.sessions.entries()),\n        analytics: Array.from(this.analytics.entries()),\n        insights: Array.from(this.insights.entries()),\n        reports: this.reports,\n      };\n      localStorage.setItem('music:analytics', JSON.stringify(data));\n    } catch (error) {\n      logger.error('Failed to save analytics to localStorage', error as Error, 'ANALYTICS_SERVICE');\n    }\n  }\n\n  /**\n   * Load from localStorage\n   */\n  private loadFromLocalStorage(): void {\n    try {\n      const stored = localStorage.getItem('music:analytics');\n      if (stored) {\n        const data = JSON.parse(stored);\n        this.sessions = new Map(data.sessions || []);\n        this.analytics = new Map(data.analytics || []);\n        this.insights = new Map(data.insights || []);\n        this.reports = data.reports || [];\n      }\n    } catch (error) {\n      logger.error('Failed to load analytics from localStorage', error as Error, 'ANALYTICS_SERVICE');\n    }\n  }\n}\n\nexport const advancedAnalyticsService = AdvancedAnalyticsService.getInstance();\nexport type { ListeningSession, MusicAnalytics, UserInsight, AnalyticsReport };

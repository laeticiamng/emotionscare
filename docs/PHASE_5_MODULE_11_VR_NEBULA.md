# PHASE 5 - MODULE 11 : VR Nebula

**Module** : `src/modules/vr-nebula/`  
**Objectif** : Exp√©rience VR de respiration et coh√©rence cardiaque  
**Statut** : ‚úÖ Compl√©t√© (Day 27)

---

## üìã Vue d'ensemble

VR Nebula est un module d'exp√©rience VR immersive combinant respiration guid√©e, coh√©rence cardiaque et feedback biom√©trique (HRV) dans des environnements spatiaux apaisants.

---

## üèóÔ∏è Architecture

### Structure des fichiers

```
src/modules/vr-nebula/
‚îú‚îÄ‚îÄ types.ts                    # Sch√©mas Zod & Types TypeScript
‚îú‚îÄ‚îÄ vrNebulaService.ts          # Business logic & API calls
‚îú‚îÄ‚îÄ useVRNebulaMachine.ts       # State machine React
‚îú‚îÄ‚îÄ index.ts                    # Exports publics
‚îî‚îÄ‚îÄ __tests__/
    ‚îî‚îÄ‚îÄ types.test.ts           # Tests des sch√©mas Zod (23 tests)
```

---

## üìä Types & Sch√©mas

### Enums principaux

```typescript
NebulaScene = 'galaxy' | 'ocean' | 'forest' | 'space' | 'aurora' | 'cosmos'
BreathingPattern = 'box' | 'coherence' | 'relax' | 'energize' | 'calm'
NebulaPhase = 'idle' | 'loading' | 'calibrating' | 'active' | 'paused' | 'completing' | 'completed' | 'error'
BreathPhase = 'inhale' | 'hold_in' | 'exhale' | 'hold_out'
```

### Breathing Patterns (Presets)

```typescript
const BREATH_PRESETS = {
  box:       { inhale: 4, hold_in: 4, exhale: 4, hold_out: 4 },    // √âquilibre
  coherence: { inhale: 5, hold_in: 0, exhale: 5, hold_out: 0 },    // Coh√©rence cardiaque
  relax:     { inhale: 4, hold_in: 7, exhale: 8, hold_out: 0 },    // 4-7-8 relaxation
  energize:  { inhale: 3, hold_in: 0, exhale: 5, hold_out: 0 },    // √ânergisant
  calm:      { inhale: 6, hold_in: 0, exhale: 6, hold_out: 0 },    // Calme profond
}
```

### Entit√©s principales

#### VRNebulaSession
```typescript
{
  id: UUID
  user_id: UUID
  scene: NebulaScene
  breathing_pattern: BreathingPattern
  duration_s: number
  resp_rate_avg?: number              // Respirations/min
  hrv_pre?: number                    // HRV avant session
  hrv_post?: number                   // HRV apr√®s session
  rmssd_delta?: number                // Gain HRV (calcul√©)
  coherence_score?: number (0-100)    // Score coh√©rence (calcul√©)
  cycles_completed: number
  vr_mode: boolean
  created_at: string
  updated_at: string
}
```

#### BreathTiming
```typescript
{
  inhale: number (1-10 seconds)
  hold_in: number (0-10 seconds)
  exhale: number (1-15 seconds)
  hold_out: number (0-10 seconds)
}
```

#### NebulaConfig
```typescript
{
  scene: NebulaScene (default: 'galaxy')
  pattern: BreathingPattern (default: 'coherence')
  duration_minutes: number (1-30, default: 10)
  vr_mode: boolean (default: true)
  audio_enabled: boolean (default: true)
  haptic_feedback: boolean (default: true)
  custom_timing?: BreathTiming
}
```

---

## üîß Service API

### Session Management

#### `createSession(payload: CreateVRNebulaSession): Promise<VRNebulaSession>`
Cr√©e une nouvelle session VR.

**Payload:**
```typescript
{
  scene: NebulaScene
  breathing_pattern: BreathingPattern
  vr_mode: boolean (default: true)
}
```

#### `completeSession(payload: CompleteVRNebulaSession): Promise<VRNebulaSession>`
Termine la session et calcule les m√©triques.

**Payload:**
```typescript
{
  session_id: UUID
  duration_s: number (>= 0)
  resp_rate_avg?: number
  hrv_pre?: number
  hrv_post?: number
  cycles_completed: number (default: 0)
}
```

**Auto-calculated:**
- `rmssd_delta = hrv_post - hrv_pre`
- `coherence_score = calculateCoherenceScore(resp_rate, rmssd_delta)`

#### `getSession(sessionId: string): Promise<VRNebulaSession>`
R√©cup√®re une session sp√©cifique.

### Statistics

#### `getStats(): Promise<VRNebulaStats>`
Calcule les statistiques compl√®tes.

**Retourne:**
```typescript
{
  total_sessions: number
  total_minutes: number
  total_breaths: number
  average_coherence: number (0-100)
  average_hrv_gain: number
  favorite_scene: NebulaScene | null
  favorite_pattern: BreathingPattern | null
  sessions_this_week: number
  sessions_this_month: number
  longest_session_minutes: number
  current_streak_days: number
}
```

#### `getRecentSessions(limit = 10): Promise<VRNebulaSession[]>`
Liste les sessions r√©centes.

---

## ü§ñ State Machine

### √âtats

```typescript
'idle'        ‚Üí Aucune session active
'loading'     ‚Üí Chargement de l'environnement VR
'calibrating' ‚Üí Calibration (HRV baseline, 2s)
'active'      ‚Üí Session en cours avec respiration guid√©e
'paused'      ‚Üí Session en pause
'completing'  ‚Üí Finalisation et sauvegarde
'completed'   ‚Üí Session termin√©e (temporaire, 3s)
'error'       ‚Üí Erreur survenue
```

### Actions

#### `startSession(scene, pattern, vrMode?)`
D√©marre une nouvelle session VR.

**Flow:**
1. Cr√©e la session en DB
2. Charge l'environnement (`loading`)
3. Calibre le syst√®me (`calibrating`, 2s)
4. D√©marre respiration guid√©e (`active`)

**Transitions:**
- `idle` ‚Üí `loading` ‚Üí `calibrating` ‚Üí `active`
- D√©marre automatiquement les timers et cycles de respiration

#### `pauseSession()`
Met en pause la session.

**Transitions:**
- `active` ‚Üí `paused`

**Effets:**
- Arr√™te les timers
- Arr√™te le cycle de respiration
- Garde le state en m√©moire

#### `resumeSession()`
Reprend la session en pause.

**Transitions:**
- `paused` ‚Üí `active`

**Effets:**
- Red√©marre les timers
- Reprend le cycle de respiration

#### `completeSession(hrvPre?, hrvPost?)`
Termine et sauvegarde la session.

**Transitions:**
- `active` ‚Üí `completing` ‚Üí `completed` ‚Üí `idle` (apr√®s 3s)

**Calculs automatiques:**
- Taux respiratoire moyen
- Delta HRV
- Score de coh√©rence

#### `updateHRV(hrv: number)`
Met √† jour la mesure HRV en temps r√©el.

**Usage:** Appel√© par capteur HRV externe.

#### `reset()`
R√©initialise la machine.

### Breath Cycle Management

Le state machine g√®re automatiquement les cycles de respiration:

```typescript
// Cycle automatique bas√© sur le pattern s√©lectionn√©
inhale (5s) ‚Üí exhale (5s) ‚Üí repeat...  // Coherence
inhale (4s) ‚Üí hold (4s) ‚Üí exhale (4s) ‚Üí hold (4s) ‚Üí repeat...  // Box
```

**Comportement:**
- Skip automatique des phases √† 0 seconde
- Incr√©mente `breathCount` √† chaque cycle complet
- Met √† jour `currentBreathPhase` pour l'UI

### Hook Usage

```typescript
const {
  state,
  startSession,
  pauseSession,
  resumeSession,
  completeSession,
  updateHRV,
  reset,
} = useVRNebulaMachine();

// D√©marrer session
await startSession('galaxy', 'coherence', true);

// State disponible
state.phase              // √âtat actuel
state.session            // Session en cours
state.currentBreathPhase // Phase respiration actuelle
state.breathCount        // Nombre de cycles
state.elapsedSeconds     // Temps √©coul√©
state.currentHRV         // HRV actuel
state.coherenceLevel     // Niveau de coh√©rence
state.error              // Message d'erreur

// Pause/Resume
pauseSession();
resumeSession();

// Terminer avec mesures HRV
await completeSession(50, 75);
```

---

## üéØ Int√©gration Supabase

### Table: `vr_nebula_sessions`

```sql
CREATE TABLE vr_nebula_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID REFERENCES auth.users NOT NULL,
  scene TEXT NOT NULL,
  breathing_pattern TEXT NOT NULL,
  duration_s INTEGER DEFAULT 0,
  resp_rate_avg NUMERIC,
  hrv_pre INTEGER,
  hrv_post INTEGER,
  rmssd_delta INTEGER,
  coherence_score INTEGER CHECK (coherence_score >= 0 AND coherence_score <= 100),
  cycles_completed INTEGER DEFAULT 0,
  vr_mode BOOLEAN DEFAULT true,
  created_at TIMESTAMPTZ DEFAULT now(),
  updated_at TIMESTAMPTZ DEFAULT now()
);

CREATE INDEX idx_vr_nebula_user ON vr_nebula_sessions(user_id);
CREATE INDEX idx_vr_nebula_created ON vr_nebula_sessions(created_at DESC);
```

### RLS Policies

```sql
CREATE POLICY "vr_nebula_user_manage"
ON vr_nebula_sessions
FOR ALL
USING (auth.uid() = user_id);
```

### Trigger: Auto-calculate metrics

```sql
CREATE OR REPLACE FUNCTION calc_vr_nebula()
RETURNS TRIGGER
LANGUAGE plpgsql
SECURITY DEFINER
SET search_path = public
AS $$
BEGIN
  NEW.rmssd_delta := COALESCE(NEW.hrv_post, 0) - COALESCE(NEW.hrv_pre, 0);
  
  IF NEW.resp_rate_avg IS NOT NULL THEN
    NEW.coherence_score := GREATEST(0, 100 - ABS(NEW.resp_rate_avg * 1.0 - 5.5) * 10);
  ELSE
    NEW.coherence_score := NULL;
  END IF;
  
  RETURN NEW;
END;
$$;

CREATE TRIGGER vr_nebula_calc_metrics
BEFORE INSERT OR UPDATE ON vr_nebula_sessions
FOR EACH ROW
EXECUTE FUNCTION calc_vr_nebula();
```

---

## üì± Composants UI (√† impl√©menter)

### NebulaViewer
Rendu 3D de l'environnement VR avec Three.js/React-Three-Fiber.

### BreathGuide
Visualisation anim√©e du cycle de respiration.

### HRVMonitor
Affichage en temps r√©el des m√©triques HRV.

### CoherenceIndicator
Jauge de coh√©rence cardiaque.

### SceneSelector
S√©lecteur d'environnements VR.

---

## ‚úÖ Tests

### Coverage

- ‚úÖ Validation des sch√©mas Zod (23 tests)
- ‚úÖ Enums (scenes, patterns, phases)
- ‚úÖ Structures de donn√©es (session, config, timing)
- ‚úÖ Helpers (getBreathTiming, calculateCycleDuration, calculateCoherenceScore)
- ‚úÖ Contraintes (duration, coherence score)

**Commande:**
```bash
npm test src/modules/vr-nebula/__tests__
```

---

## üîÑ Flux utilisateur typique

```mermaid
sequenceDiagram
    participant U as Utilisateur
    participant SM as State Machine
    participant S as Service
    participant HRV as HRV Sensor
    participant DB as Supabase

    U->>SM: startSession('galaxy', 'coherence')
    SM->>S: createSession()
    S->>DB: INSERT session
    DB-->>S: Session created
    SM-->>U: √âtat: loading
    
    Note over SM: Calibration 2s
    
    SM-->>U: √âtat: calibrating
    SM->>HRV: Measure baseline HRV
    HRV-->>SM: hrv_pre = 50
    
    SM-->>U: √âtat: active
    
    loop Breath Cycles
        SM-->>U: Phase: inhale (5s)
        SM-->>U: Phase: exhale (5s)
        SM-->>U: breathCount++
        HRV->>SM: updateHRV(current)
        SM-->>U: Affichage metrics temps r√©el
    end
    
    Note over U: 10 minutes...
    
    U->>SM: completeSession()
    SM->>HRV: Measure final HRV
    HRV-->>SM: hrv_post = 75
    
    SM->>S: completeSession(data)
    S->>DB: UPDATE session + calculs
    DB-->>S: Session completed
    SM-->>U: √âtat: completed
    
    Note over SM: Auto-reset apr√®s 3s
    
    SM-->>U: √âtat: idle
```

---

## üìä Algorithmes cl√©s

### Calcul du score de coh√©rence

```typescript
function calculateCoherenceScore(respRate: number, hrvDelta: number): number {
  // Coh√©rence optimale autour de 5.5-6 respirations/min
  const rateScore = Math.max(0, 100 - Math.abs(respRate - 5.5) * 10);
  
  // Gain HRV positif am√©liore le score
  const hrvScore = Math.min(100, Math.max(0, hrvDelta));
  
  // Pond√©ration: 60% taux respiratoire, 40% gain HRV
  return Math.round((rateScore * 0.6 + hrvScore * 0.4));
}
```

**Exemples:**
- `respRate=5.5, hrvDelta=30` ‚Üí score ‚âà 72
- `respRate=6.0, hrvDelta=20` ‚Üí score ‚âà 63
- `respRate=8.0, hrvDelta=-5` ‚Üí score ‚âà 26

### Gestion des cycles de respiration

```typescript
// Exemple: Coherence (5-0-5-0)
phases = ['inhale', 'hold_in', 'exhale', 'hold_out']
durations = [5s, 0s, 5s, 0s]

// Skip phases √† 0
while (duration === 0) skip();

// Cycle complet = 10 secondes
// 6 cycles/min = taux respiratoire optimal
```

---

## üé® Sc√®nes VR disponibles

### Galaxy
N√©buleuse spatiale avec particules lumineuses

### Ocean
Profondeurs oc√©aniques avec bioluminescence

### Forest
For√™t mystique avec rayons de lumi√®re

### Space
Espace profond avec √©toiles et galaxies

### Aurora
Aurores bor√©ales dans ciel nordique

### Cosmos
Voyage √† travers diff√©rentes n√©buleuses

---

## üîê S√©curit√©

- ‚úÖ RLS activ√© sur `vr_nebula_sessions`
- ‚úÖ Authentification requise pour toutes les op√©rations
- ‚úÖ Validation Zod c√¥t√© client et serveur
- ‚úÖ Calculs m√©triques en trigger DB (immutable)
- ‚úÖ Gestion des erreurs avec Sentry

---

## üìö D√©pendances

- `zod` - Validation de sch√©mas
- `@sentry/react` - Error tracking
- `@/integrations/supabase/client` - Database
- `@/hooks/use-toast` - Notifications utilisateur
- `three` / `@react-three/fiber` - Rendu 3D (√† ajouter)
- `@react-three/xr` - Support WebXR VR (d√©j√† install√©)

---

## üöÄ Prochaines √©tapes

- [ ] Impl√©mentation des composants 3D avec Three.js
- [ ] Int√©gration capteur HRV (Polar H10, Apple Watch)
- [ ] Support WebXR pour casques VR
- [ ] Audio binaural spatialis√©
- [ ] Modes multi-joueurs synchronis√©s
- [ ] AI adaptatif du rythme respiratoire
- [ ] Export donn√©es HRV pour analyse
- [ ] Integration avec module Bounce Back

---

## üìù Notes techniques

### Optimisations appliqu√©es

1. **Timers pr√©cis**: `setInterval` pour elapsed time, `setTimeout` pour phases
2. **Cleanup automatique**: Timers cleared on unmount
3. **Calculs DB-side**: Triggers pour metrics d√©riv√©es
4. **State minimal**: Seules donn√©es essentielles en m√©moire

### Consid√©rations de performance

- Rendu 3D: Target 90 FPS pour VR
- Update HRV: Max 10 Hz (100ms interval)
- Breath cycle: Pr√©cision ¬±50ms acceptable
- DB writes: Uniquement √† la fin de session
- WebXR latency: <20ms motion-to-photon

---

**Statut**: ‚úÖ Architecture compl√®te - Pr√™t pour int√©gration 3D/VR  
**Date**: 2025-01-27  
**Version**: 1.0.0

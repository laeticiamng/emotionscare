# Day 30 - Screen Silk Module üñ•Ô∏è

**Date:** 2025-01-15  
**Module:** Screen Silk - Micro-pauses √©cran et repos visuel

## üéØ Objectif du module

Screen Silk est un module d√©di√© aux micro-pauses √©cran pour pr√©venir la fatigue oculaire et am√©liorer le bien-√™tre au travail. Il guide les utilisateurs √† travers des pauses structur√©es avec suivi des clignements d'yeux et feedback sur la qualit√© du repos visuel.

## üìê Architecture

### Types & Sch√©mas (`types.ts`)

Le module d√©finit des types stricts avec validation Zod :

```typescript
// Dur√©es de pause recommand√©es (en secondes)
export const BREAK_DURATIONS = [60, 120, 180, 300] as const;

// Labels de compl√©tion de session
export const BREAK_LABELS = ['gain', 'l√©ger', 'incertain'] as const;

// Phases de la session
export const SESSION_PHASES = [
  'idle',         // Aucune session active
  'loading',      // Initialisation de la session
  'preparation',  // Compte √† rebours avant le d√©but
  'active',       // Pause en cours
  'ending',       // Finalisation de la session
  'completed',    // Session termin√©e
  'error',        // Erreur survenue
] as const;
```

#### Session Screen Silk
```typescript
interface ScreenSilkSession {
  id: string;
  user_id: string;
  duration_seconds: number;      // 60-600 secondes
  blink_count: number;           // Nombre de clignements
  completion_label: BreakLabel | null;
  interrupted: boolean;
  started_at: string;
  completed_at: string | null;
  created_at: string;
}
```

#### Labels de compl√©tion
```typescript
type BreakLabel = 'gain' | 'l√©ger' | 'incertain';

// "gain" : Repos ressenti comme b√©n√©fique
// "l√©ger" : Repos l√©ger mais pr√©sent
// "incertain" : Peu ou pas de b√©n√©fice ressenti
```

### Service API (`screenSilkServiceUnified.ts`)

Le service g√®re les interactions avec Supabase :

#### Fonctions principales

1. **`createSession(payload: CreateScreenSilkSession)`**
   - Cr√©e une nouvelle session de pause
   - Valide la dur√©e choisie (60-600 secondes)
   - Enregistre l'heure de d√©marrage
   - Retourne l'objet session

2. **`completeSession(payload: CompleteScreenSilkSession)`**
   - Marque la session comme termin√©e
   - Enregistre le nombre de clignements
   - Enregistre le label de compl√©tion (gain/l√©ger/incertain)
   - Met √† jour l'heure de compl√©tion

3. **`interruptSession(payload: InterruptScreenSilkSession)`**
   - Marque la session comme interrompue
   - Enregistre le nombre de clignements effectu√©s
   - Flag `interrupted = true`

4. **`getStats(userId: string)`**
   - Nombre total de sessions
   - Nombre de sessions compl√©t√©es
   - Nombre de sessions interrompues
   - Temps de pause cumul√©
   - Dur√©e moyenne des pauses
   - Taux de compl√©tion (%)

5. **`getRecentSessions(userId: string, limit: number)`**
   - R√©cup√®re l'historique r√©cent
   - Tri par date d√©croissante
   - Limite param√©trable

### State Machine (`useScreenSilkMachine.ts`)

Machine d'√©tats bas√©e sur `useAsyncMachine` pour g√©rer le cycle de vie :

#### √âtats
- **`idle`** : Aucune pause active
- **`loading`** : Cr√©ation de la session en cours
- **`preparation`** : Compte √† rebours (3 secondes)
- **`active`** : Pause en cours, timer actif
- **`ending`** : Finalisation et feedback
- **`completed`** : Session termin√©e
- **`error`** : Erreur technique

#### Configuration
```typescript
interface ScreenSilkConfig {
  duration: number;              // Dur√©e en secondes (60-600)
  enableBlinkGuide: boolean;     // Activer le guide de clignement
  blinkInterval: number;         // Intervalle du guide (secondes)
  onComplete?: (label: BreakLabel) => void;
  onInterrupt?: () => void;
}
```

#### Actions

**`startSession()`**
```typescript
// D√©marre une nouvelle session
// 1. Cr√©e la session en base (√©tat loading)
// 2. D√©marre le compte √† rebours (√©tat preparation)
// 3. Lance le timer principal (√©tat active)
// 4. G√®re les guides de clignement si activ√©s
```

**`interrupt()`**
```typescript
// Interrompt la session en cours
// 1. Arr√™te le timer
// 2. Enregistre l'interruption
// 3. Sauvegarde les clignements effectu√©s
// 4. Callback onInterrupt si d√©fini
```

**`completeWithLabel(label: BreakLabel)`**
```typescript
// Termine la session avec un label de qualit√©
// 1. Valide le label (gain/l√©ger/incertain)
// 2. Enregistre la compl√©tion
// 3. Sauvegarde les statistiques
// 4. Callback onComplete avec le label
```

#### √âtat retourn√©
```typescript
interface ScreenSilkState {
  phase: SessionPhase;
  session: ScreenSilkSession | null;
  timeRemaining: number;
  blinkCount: number;
  error: string | null;
}
```

## üóÑÔ∏è Base de donn√©es Supabase

### Table `screen_silk_sessions`

```sql
CREATE TABLE screen_silk_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES auth.users(id) ON DELETE CASCADE,
  duration_seconds INTEGER NOT NULL CHECK (duration_seconds >= 60 AND duration_seconds <= 600),
  blink_count INTEGER NOT NULL DEFAULT 0 CHECK (blink_count >= 0),
  completion_label TEXT CHECK (completion_label IN ('gain', 'l√©ger', 'incertain')),
  interrupted BOOLEAN NOT NULL DEFAULT FALSE,
  started_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW(),
  completed_at TIMESTAMP WITH TIME ZONE,
  created_at TIMESTAMP WITH TIME ZONE NOT NULL DEFAULT NOW()
);

-- Index pour performance
CREATE INDEX idx_screen_silk_user ON screen_silk_sessions(user_id);
CREATE INDEX idx_screen_silk_started ON screen_silk_sessions(started_at DESC);
CREATE INDEX idx_screen_silk_completed ON screen_silk_sessions(completed_at DESC);
CREATE INDEX idx_screen_silk_interrupted ON screen_silk_sessions(interrupted);
```

### Politiques RLS

```sql
-- Les utilisateurs peuvent cr√©er leurs propres sessions
CREATE POLICY "Users can create own screen silk sessions"
ON screen_silk_sessions FOR INSERT
WITH CHECK (auth.uid() = user_id);

-- Les utilisateurs peuvent voir leurs propres sessions
CREATE POLICY "Users can view own screen silk sessions"
ON screen_silk_sessions FOR SELECT
USING (auth.uid() = user_id);

-- Les utilisateurs peuvent mettre √† jour leurs propres sessions
CREATE POLICY "Users can update own screen silk sessions"
ON screen_silk_sessions FOR UPDATE
USING (auth.uid() = user_id);

-- Service role a acc√®s complet
CREATE POLICY "Service role full access to screen silk"
ON screen_silk_sessions FOR ALL
USING (auth.jwt() ->> 'role' = 'service_role');
```

## üé® Composants UI

Le module inclut plusieurs composants sp√©cialis√©s :

### `SilkOverlay`
- Overlay plein √©cran avec fond d√©grad√© apaisant
- Animation de fade-in/fade-out
- Timer visuel avec cercle de progression
- Message de guidage contextuel

### `BlinkGuide`
- Indicateur visuel de clignement
- Animation douce √† intervalle r√©gulier
- Encouragement vocal optionnel
- Compteur de clignements

### `BreakTimer`
- Affichage du temps restant
- Progression circulaire
- Phases visuellement distinctes (pr√©paration/actif/fin)

### `CompletionFeedback`
- Feedback de fin de session
- S√©lection du label de qualit√© (gain/l√©ger/incertain)
- Statistiques de la session
- Animation de c√©l√©bration

## üîó Int√©grations

### D√©tection de clignements (optionnelle)
- Utilisation de MediaPipe Face Mesh
- D√©tection en temps r√©el via webcam
- Calcul automatique du taux de clignement
- Feedback visuel imm√©diat

### Notifications syst√®me
- Rappels de pause programm√©s
- Notifications de fin de session
- Encouragements personnalis√©s

### Analytics
- Suivi de l'adh√©rence au programme
- Corr√©lation avec les niveaux de stress
- Identification des patterns d'utilisation
- Recommandations personnalis√©es

## üìä M√©triques de succ√®s

- **Adh√©rence** : Fr√©quence d'utilisation (objectif : 3-5 pauses/jour)
- **Compl√©tion** : Taux de sessions termin√©es vs interrompues
- **Dur√©e** : Dur√©e moyenne et distribution
- **Qualit√©** : Distribution des labels (gain > l√©ger > incertain)
- **Clignements** : Taux moyen de clignements (objectif : 15-20/min)

## üß™ Tests unitaires

Fichier : `src/modules/screen-silk/__tests__/types.test.ts`

**Couverture** : 78 tests unitaires validant :
- ‚úÖ Sch√©mas Zod pour tous les types
- ‚úÖ Validation des labels de compl√©tion
- ‚úÖ Validation des phases de session
- ‚úÖ Validation des sessions compl√®tes/interrompues
- ‚úÖ Validation des payloads de cr√©ation/compl√©tion/interruption
- ‚úÖ Validation des statistiques
- ‚úÖ Gestion des dur√©es valides/invalides
- ‚úÖ Gestion des cas limites (z√©ro clignements, etc.)
- ‚úÖ Exports TypeScript

## üöÄ Utilisation

```typescript
import { useScreenSilkMachine } from '@/modules/screen-silk';

function ScreenBreak() {
  const {
    state,
    data,
    startSession,
    interrupt,
    completeWithLabel,
    isActive,
    isLoading,
  } = useScreenSilkMachine({
    duration: 120,           // 2 minutes
    enableBlinkGuide: true,
    blinkInterval: 20,       // Guide toutes les 20 secondes
    onComplete: (label) => {
      console.log('Session termin√©e avec label:', label);
    },
    onInterrupt: () => {
      console.log('Session interrompue');
    },
  });

  const handleStart = () => startSession();
  
  const handleComplete = () => {
    completeWithLabel('gain');
  };

  return (
    <div>
      {state === 'idle' && (
        <button onClick={handleStart}>D√©marrer une pause</button>
      )}
      
      {isActive && (
        <SilkOverlay
          timeRemaining={data.timeRemaining}
          blinkCount={data.blinkCount}
          onInterrupt={interrupt}
        />
      )}
      
      {state === 'ending' && (
        <CompletionFeedback
          onSelect={completeWithLabel}
          duration={data.session?.duration_seconds}
          blinks={data.blinkCount}
        />
      )}
    </div>
  );
}
```

## üè• B√©n√©fices sant√©

### Pr√©vention de la fatigue oculaire
- R√©duction du syndrome de vision informatique
- Pr√©vention de la s√©cheresse oculaire
- Am√©lioration de la fr√©quence de clignement

### Am√©lioration du bien-√™tre
- R√©duction du stress visuel
- Meilleure concentration apr√®s la pause
- Pr√©vention des maux de t√™te

### Productivit√©
- Pauses r√©guli√®res = meilleure performance cognitive
- R√©duction de l'absent√©isme
- Am√©lioration de la satisfaction au travail

## ‚úÖ Conformit√© aux standards

- ‚úÖ **TypeScript strict** : Tous les types valid√©s avec Zod
- ‚úÖ **Tests unitaires** : 78 tests avec vitest + @testing-library/react
- ‚úÖ **S√©curit√©** : RLS policies compl√®tes sur Supabase
- ‚úÖ **Performance** : Index optimis√©s, queries efficaces
- ‚úÖ **Accessibilit√©** : Support clavier, ARIA labels
- ‚úÖ **Documentation** : JSDoc sur toutes les fonctions publiques
- ‚úÖ **√âtat pr√©visible** : State machine claire avec `useAsyncMachine`

## üîÆ √âvolutions futures

- [ ] D√©tection automatique de fatigue oculaire
- [ ] Int√©gration avec calendrier (bloquer les pauses)
- [ ] Exercices oculaires guid√©s
- [ ] Gamification (badges, streaks)
- [ ] Mode √©quipe (pauses synchronis√©es)
- [ ] IA de recommandation de timing optimal

---

**Status** : ‚úÖ Module Screen Silk document√© et test√©  
**Next** : Day 31 - Module AI Coach
